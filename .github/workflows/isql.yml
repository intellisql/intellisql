name: isql Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  isql-test:
    name: isql Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build isql Package
        shell: bash
        run: ./mvnw clean package -DskipTests -pl intellisql-distribution/intellisql-distribution-client -am

      - name: Extract and Test isql (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        timeout-minutes: 2
        env:
          JLINE_TERMINAL: dumb
        run: |
          cd intellisql-distribution/intellisql-distribution-client/target/
          tar -xzf isql-1.0.0-SNAPSHOT.tar.gz
          DIST_DIR="isql-1.0.0-SNAPSHOT"
          chmod +x "$DIST_DIR/bin/isql.sh"
          echo "Testing Help..."
          "$DIST_DIR/bin/isql.sh" --help
          echo "Testing Version..."
          "$DIST_DIR/bin/isql.sh" --version
          echo "Testing Execute..."
          "$DIST_DIR/bin/isql.sh" -e "SELECT 1"

      - name: Extract and Test isql (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        timeout-minutes: 2
        env:
          JLINE_TERMINAL: dumb
        run: |
          cd intellisql-distribution/intellisql-distribution-client/target/
          Expand-Archive -Path isql-1.0.0-SNAPSHOT.zip -DestinationPath .
          $DIST_DIR = "isql-1.0.0-SNAPSHOT"
          echo "Testing Help..."
          & "$DIST_DIR/bin/isql.bat" --help
          echo "Testing Version..."
          & "$DIST_DIR/bin/isql.bat" --version
          echo "Testing Execute..."
          & "$DIST_DIR/bin/isql.bat" -e "SELECT 1"
