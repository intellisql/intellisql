#!/bin/bash
#
# Licensed to the IntelliSQL Project under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The IntelliSQL Project licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# ============================================================================
# IntelliSQL CLI Client Script
# ============================================================================

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_HOME="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Default configuration
APP_NAME="intellisql-cli"
MAIN_CLASS="com.intellisql.client.IntelliSqlClient"
CONF_DIR="${PROJECT_HOME}/conf"
LIB_DIR="${PROJECT_HOME}/lib"

# Default connection settings
DEFAULT_HOST="localhost"
DEFAULT_PORT="8765"
DEFAULT_USER="root"
DEFAULT_DATABASE="intellisql"

# Parse command line arguments
HOST="${DEFAULT_HOST}"
PORT="${DEFAULT_PORT}"
USER="${DEFAULT_USER}"
DATABASE="${DEFAULT_DATABASE}"
PASSWORD=""
EXECUTE=""
FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--host)
            HOST="$2"
            shift 2
            ;;
        -P|--port)
            PORT="$2"
            shift 2
            ;;
        -u|--user)
            USER="$2"
            shift 2
            ;;
        -p|--password)
            PASSWORD="$2"
            shift 2
            ;;
        -d|--database)
            DATABASE="$2"
            shift 2
            ;;
        -e|--execute)
            EXECUTE="$2"
            shift 2
            ;;
        -f|--file)
            FILE="$2"
            shift 2
            ;;
        --help)
            echo "IntelliSQL CLI - Interactive SQL Client"
            echo ""
            echo "Usage: isql [OPTIONS]"
            echo ""
            echo "Connection Options:"
            echo "  -h, --host HOST       Server host (default: localhost)"
            echo "  -P, --port PORT       Server port (default: 8765)"
            echo "  -u, --user USER       Username (default: root)"
            echo "  -p, --password PASS   Password"
            echo "  -d, --database DB     Database name (default: intellisql)"
            echo ""
            echo "Execution Options:"
            echo "  -e, --execute SQL     Execute SQL statement and exit"
            echo "  -f, --file FILE       Execute SQL file and exit"
            echo ""
            echo "Examples:"
            echo "  # Connect to local server"
            echo "  isql"
            echo ""
            echo "  # Connect to remote server"
            echo "  isql -h db.example.com -P 8765 -u admin"
            echo ""
            echo "  # Execute a query"
            echo "  isql -e 'SELECT * FROM users LIMIT 10'"
            echo ""
            echo "  # Execute a SQL file"
            echo "  isql -f queries.sql"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
        *)
            # Positional argument - treat as database name
            DATABASE="$1"
            shift
            ;;
    esac
done

# Build classpath
CLASSPATH="${CONF_DIR}"
if [ -d "$LIB_DIR" ]; then
    for jar in "${LIB_DIR}"/*.jar; do
        if [ -f "$jar" ]; then
            CLASSPATH="${CLASSPATH}:${jar}"
        fi
    done
fi

# Build JVM arguments
JAVA_OPTS=(
    "-Dlogback.configurationFile=${CONF_DIR}/logback.xml"
    "-Dfile.encoding=UTF-8"
    "-Djline.terminal=jline.UnsupportedTerminal"
)

# Build JDBC URL
JDBC_URL="jdbc:intellisql://${HOST}:${PORT}/${DATABASE}"

# Build program arguments (positional: url, username, password)
PROGRAM_ARGS=(
    "${JDBC_URL}"
    "${USER}"
)

if [ -n "$PASSWORD" ]; then
    PROGRAM_ARGS+=("${PASSWORD}")
else
    PROGRAM_ARGS+=("")
fi

if [ -n "$EXECUTE" ]; then
    PROGRAM_ARGS+=("-e" "${EXECUTE}")
fi

if [ -n "$FILE" ]; then
    PROGRAM_ARGS+=("-f" "${FILE}")
fi

# Print connection info
echo "IntelliSQL CLI v1.0.0"
echo "Connecting to ${HOST}:${PORT}/${DATABASE}..."
echo ""

# Run the CLI
java "${JAVA_OPTS[@]}" -cp "${CLASSPATH}" "${MAIN_CLASS}" "${PROGRAM_ARGS[@]}"
