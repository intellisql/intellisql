#!/bin/bash
#
# Licensed to the IntelliSQL Project under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The IntelliSQL Project licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# ============================================================================
# IntelliSQL CLI Client Script (Supporting Native Image and JAR modes)
# ============================================================================
#
# This script supports three execution modes (in order of priority):
# 1. Native Image binary - fastest startup, compiled with GraalVM
# 2. Fat JAR mode - using shaded JAR with all dependencies
# 3. Classpath mode - using lib/ directory with individual JARs
#
# Directory layouts supported:
#
# Development/CI layout:
#   bin/isql
#   target/isql              (native binary)
#   target/isql-*.jar        (fat JAR)
#
# Distribution layout:
#   bin/isql
#   bin/isql.exe             (native binary on Windows)
#   lib/isql-*.jar           (fat JAR)
#   lib/*.jar                (individual JARs for classpath mode)
#

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_HOME="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Configuration
APP_NAME="isql"
MAIN_CLASS="com.intellisql.client.IntelliSqlClient"
LIB_DIR="${PROJECT_HOME}/lib"
TARGET_DIR="${PROJECT_HOME}/target"

# Determine the binary name based on OS
NATIVE_BINARY=""
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
    BINARY_NAME="isql.exe"
else
    BINARY_NAME="isql"
fi

# ============================================================================
# Mode 1: Native Image Binary (preferred for performance)
# ============================================================================
# Search priority:
# 1. Same directory as script (distribution layout)
# 2. Target directory (development/CI layout)

if [ -f "${SCRIPT_DIR}/${BINARY_NAME}" ]; then
    NATIVE_BINARY="${SCRIPT_DIR}/${BINARY_NAME}"
elif [ -f "${TARGET_DIR}/${BINARY_NAME}" ]; then
    NATIVE_BINARY="${TARGET_DIR}/${BINARY_NAME}"
fi

if [ -n "${NATIVE_BINARY}" ]; then
    exec "${NATIVE_BINARY}" "$@"
fi

# ============================================================================
# Mode 2: Fat JAR (shaded JAR with all dependencies)
# ============================================================================
# Search priority:
# 1. lib/ directory (distribution layout)
# 2. target/ directory (development/CI layout)

JAR_PATH=""

# Check lib/ directory first (distribution layout)
if [ -d "${LIB_DIR}" ]; then
    JAR_PATH=$(ls "${LIB_DIR}"/isql-*.jar 2>/dev/null | grep -v "sources.jar" | head -n 1)
fi

# Fall back to target/ directory (development/CI layout)
if [ -z "${JAR_PATH}" ] && [ -d "${TARGET_DIR}" ]; then
    JAR_PATH=$(ls "${TARGET_DIR}"/isql-*.jar 2>/dev/null | grep -v "sources.jar" | grep -v "original-" | head -n 1)
fi

if [ -n "${JAR_PATH}" ] && [ -f "${JAR_PATH}" ]; then
    exec java -jar "${JAR_PATH}" "$@"
fi

# ============================================================================
# Mode 3: Classpath mode (individual JARs in lib/)
# ============================================================================

if [ -d "${LIB_DIR}" ]; then
    CLASSPATH=""
    JAR_COUNT=0
    for jar in "${LIB_DIR}"/*.jar; do
        if [ -f "$jar" ]; then
            if [ -z "${CLASSPATH}" ]; then
                CLASSPATH="${jar}"
            else
                CLASSPATH="${CLASSPATH}:${jar}"
            fi
            JAR_COUNT=$((JAR_COUNT + 1))
        fi
    done

    if [ ${JAR_COUNT} -gt 0 ]; then
        exec java -cp "${CLASSPATH}" "${MAIN_CLASS}" "$@"
    fi
fi

# ============================================================================
# Error: No executable found
# ============================================================================

echo "Error: Could not find ${APP_NAME} executable." >&2
echo "" >&2
echo "Searched locations:" >&2
echo "  Native binary: ${SCRIPT_DIR}/${BINARY_NAME}" >&2
echo "  Native binary: ${TARGET_DIR}/${BINARY_NAME}" >&2
echo "  JAR file:      ${LIB_DIR}/isql-*.jar" >&2
echo "  JAR file:      ${TARGET_DIR}/isql-*.jar" >&2
echo "" >&2
echo "Please build the project first:" >&2
echo "  ./mvnw clean package -pl intellisql-distribution/intellisql-distribution-client -am" >&2
echo "" >&2
echo "For native image build:" >&2
echo "  ./mvnw clean package -Pnative -pl intellisql-distribution/intellisql-distribution-client -am" >&2
exit 1
